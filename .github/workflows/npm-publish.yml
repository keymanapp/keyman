#
# Keyman is copyright (C) SIL Global. MIT License.
#
# Created by mcdurdin on 2025-10-27
#
# This workflow publishes all our NPM packages using Trusted Publishers OIDC
# permissions. It is triggered by a repository_dispatch event with the types
# `npm-publish:*`, from the trigger-builds infrastructure. For test builds, this
# does a `npm pack` only.
#
# Inputs:
#   buildSha:    The SHA of the commit to build, e.g. of the branch or
#                refs/pull/1234/head for PR
#   user:        The user that triggered the build or created the PR
#   isTestBuild: false for Releases, otherwise true

name: "NPM publish"
run-name: "NPM publish - sha: ${{ github.event.client_payload.buildSha }}, user: @${{ github.event.client_payload.user }}, isTestBuild: ${{ github.event.client_payload.isTestBuild }}"
on:
  repository_dispatch:
    types: ['npm-publish:*']

permissions:
  id-token: write  # Required for OIDC
  contents: read

env:
  GH_TOKEN: ${{ github.token }}
  STATUS_CONTEXT: 'NPM Pack'

jobs:
  npm-publish:
    name: Publish or pack @keymanapp packages
    if: github.repository == 'keymanapp/keyman' || github.event.client_payload.force
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 #v4.2.2
      with:
        ref: '${{ github.event.client_payload.buildSha }}'


    - name: Report initial npm/node versions
      run: |
        echo "Initial npm/node versions"
        npm -v
        node -v

    - uses: actions/setup-node@v6
      with:
        node-version: '24.10'

    - name: Report current npm/node versions
      run: |
        echo "Current npm/node versions"
        npm -v
        node -v

    - name: NPM pack
      if: github.event.client_payload.isTestBuild == 'true'
      run: |
        if [[ -f ./resources/build/ci/npm-publish.sh ]]; then
          ./resources/build/ci/npm-publish.sh pack
        else
          echo WARNING: npm-publish.sh is not yet available on this branch
        fi

    - name: NPM publish
      if: github.event.client_payload.isTestBuild == 'false'
      run: |
        if [[ -f ./resources/build/ci/npm-publish.sh ]]; then
          ./resources/build/ci/npm-publish.sh publish
        else
          echo WARNING: npm-publish.sh is not yet available on this branch
        fi
